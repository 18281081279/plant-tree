<!DOCTYPE html>

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Forest</title>
  <link href="./treeStyle.css" rel="stylesheet" type="text/css" />
</head>

<body>
  <div id="container">
    <input type="color" value="#2291a9" />
    <canvas id="tree" ref='tree'></canvas>
    <!-- 背景图片 -->
    <div v-if="index==4">
      <canvas id="dot" style="background:linear-gradient(to bottom, #4e4b4d, #352b2c);z-index:-1">
        <p>your browser not support canvas</p>
      </canvas>
    </div>
    <div v-else-if="index==5">
      <div class="viewport"></div>
    </div>
    <div v-else>
      <img :src='imgArr1[index]' id="backgroundImg">
    </div>
    <!--背景音乐-->
    <audio :src="musicArr[index]" loop autoplay id="backgroundMusic"></audio>
    <!-- 生长音乐 -->
    <audio src='./musics/grow1.wav' loop id="growMusic"></audio>
    <!-- 顶部导航 -->
    <div id="top">
      <div id="topLeft" :style="{'color':btnColors[index]}" @click="prev"><</div>
      <img :src='imgArr2[index]' id="topImg">
      <div id="topFont" :style="{'color':fontColors[index]}">{{fontArr[index]}}</div>
      <div id="topRight" :style="{'color':btnColors[index]}" @click="next"> > </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="./js/branch.js"></script>
  <script src="./js/dot.js"></script>

  <script src="js/three.min.js"></script>
  <script src="js/dat.gui.min.js"></script>
  <script src="js/TweenMax.min.js"></script>
  <script src="./js/bird.js"></script>
  <script></script>
  <script>
    let container = new Vue({
      el: "#container",
      data: {
        fontArr: ['春', '夏', '秋', '冬', '黑'], //主题名字
        imgArr1: ['./pictures/spring1.png', './pictures/summer1.png', './pictures/autumn1.png',
          './pictures/winter1.png', './pictures/black1.png'
        ], //背景图片
        musicArr: ['./musics/spring1.mp3', './musics/summer1.wav', './musics/autumn1.wav', './musics/winter1.wav', './musics/night1.wav'],//背景音乐
        imgArr2: ['./pictures/spring.gif', './pictures/summer.gif', './pictures/autumn.gif',
          './pictures/winter.gif', './pictures/black.gif'
        ], //春夏秋冬顶部导航图片
        fontColors: ['rgba(255, 255, 255, 1)', 'rgba(50, 188, 187, 1)', 'rgb(202, 136, 89)', 'rgb(89, 89, 89)',
          'rgb(255,255,255)'
        ], //春夏秋冬字体颜色
        btnColors: ['rgba(255, 255, 255, 1)', 'rgba(255, 255, 255, 1)', 'rgba(255, 255, 255, 1)',
          'rgba(218, 218, 218, 1)', 'rgb(255,255,255)'
        ], //切换的按钮的颜色
        index: 0,
      },
      watch: {
        index(value) {
          if (value === 4) {
            setTimeout(() => {
              Dot("dot", {
                cW: width,
                cH: height
              });
            }, 0)

          }
        }
      },
      methods: {
        next: function () {
          if (this.index == this.imgArr1.length - 1) {
            this.index = 0;
          } else {
            this.index++;
          }
          this.clearCanvas();
        },
        prev: function () {
          if (this.index == 0) {
            this.index = this.imgArr1.length - 1;
          } else {
            this.index--;
          }
          this.clearCanvas();
        },
        clearCanvas: function () {
          // var c = document.getElementById("tree");
          let c = this.$refs.tree;
          var cxt = c.getContext("2d");
          cxt.clearRect(0, 0, c.width, c.height);
        }
      }
    })
    const canvas = document.getElementById('tree');
    const width = window.innerWidth;
    const height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
    let initX;
    const initY = height;
    let initRadius;

    window.onresize = function () {
      location.reload();
    };

    function radiusType(percentage) {
      switch (true) {
        case 0 < percentage && percentage < 0.2:
          return Math.random() * (7 - 5 + 1) + 5;
          break;
        case 0.2 <= percentage && percentage < 0.7:
          return Math.random() * (6.5 - 4 + 1) + 4;
          break;
        case 0.7 <= percentage && percentage < 1.0:
          return Math.random() * (4 - 2 + 1) + 2;
          break;
        default:
          return 5;
          break;
      }
    }

    const branchSet = {
      branches: [], //保存树枝的数组

      // 添加树枝的方法
      add(branch) {
        this.branches.push(branch);
      },

      // 移除树枝的方法
      remove(branch) {
        /* for (let index in this.branches) {
          if (this.branches[index] === branch) this.branches.splice(index, 1);
        } */

        const index = this.branches.indexOf(branch);
        this.branches.splice(index, 1);

        //停止生长音乐播放
        if(this.branches.length==0){
          let growMusic = document.getElementById('growMusic');
          growMusic.pause();
        }
      },

      // 调用每个树枝对象的开始方法
      start() {
        for (let index in this.branches) {
          this.branches[index].start();
        }
      },
    };

    canvas.addEventListener('click', () => {
      initX = window.event.clientX;
      initHeight = window.event.clientY;
      const branch = new Branch();
      branchSet.add(branch);
      // canvas.style = 'pointer-events:none';
      // 定义并添加最初始的树枝

      // 启动进程
      branchSet.start();

      //播放生长音乐
      let growMusic = document.getElementById('growMusic');
      let a = document.getElementById('backgroundMusic');
      a.play();
      growMusic.play();

      // 制作动画效果
      const Time = setInterval(function () {
        branchSet.start();
        if (branchSet.branches.length === 0) {
          clearInterval(Time);
          console.log(stop);
        }
      }, 4);
    });
  </script>
</body>

</html>